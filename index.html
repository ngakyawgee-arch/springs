<!DOCTYPE html>
<html lang="my">
<head>
<meta charset="UTF-8">
<title>á€–á€­á€¯á€¸á€…á€±á€¬á€„á€·á€ºá€á€±á€¬á€„á€ºá€™á€®á€¸á€¡á€­á€™á€º (LFM)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<!-- Export -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{margin:0;background:#0d0d0d;color:#fff;font-family:sans-serif}
.container{max-width:420px;margin:auto;padding:15px}
.card{background:#1a1a1a;padding:15px;border-radius:14px;margin-bottom:12px}
h2,h3{text-align:center;margin:6px 0}
input,button{width:100%;padding:12px;margin:6px 0;border-radius:10px;border:none}
button{background:#1e8f4d;color:#fff;font-weight-bold}
button:disabled{opacity:0.5;cursor:not-allowed}
.gray{background:#333}
.red{background:#b71c1c}
.hide{display:none}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid #333;padding:6px;text-align:center;font-size:13px}
footer{text-align:center;opacity:.6;margin-top:20px}
.small{font-size:12px;opacity:.8}
.actionBtn{padding:4px 8px;font-size:12px}
.loading{text-align:center;padding:20px}
</style>
</head>

<body>
<div class="container">

<h2>âœŠ á€–á€­á€¯á€¸á€…á€±á€¬á€„á€·á€ºá€á€±á€¬á€„á€ºá€™á€®á€¸á€¡á€­á€™á€º (LFM)</h2>
<p class="small" align="center">á€á€±á€¬á€ºá€œá€¾á€”á€ºá€›á€±á€¸á€€á€­á€¯ á€¡á€¬á€¸á€•á€±á€¸á€á€±á€¬ á€¡á€œá€¾á€°á€›á€¾á€„á€ºá€™á€»á€¬á€¸á á€™á€¾á€á€ºá€á€™á€ºá€¸</p>

<!-- LOGIN -->
<div id="loginBox" class="card">
  <h3>Admin Login</h3>
  <input id="email" type="email" placeholder="Admin Email" value="admin@lfm.com">
  <input id="password" type="password" placeholder="Admin Password" value="admin123">
  <button onclick="adminLogin()" id="adminLoginBtn">Admin á€á€„á€ºá€™á€Šá€º</button>
  <div id="loginStatus" class="small" style="text-align:center;margin-top:10px;"></div>
  <hr>
  <h3>Member Login</h3>
  <input id="memberPin" placeholder="Member PIN" value="1111">
  <button class="gray" onclick="memberLogin()" id="memberLoginBtn">Member á€á€„á€ºá€™á€Šá€º</button>
</div>

<!-- LOADING -->
<div id="loadingBox" class="card hide">
  <div class="loading">á€œá€¯á€•á€ºá€†á€±á€¬á€„á€ºá€”á€±á€•á€«á€á€Šá€º...</div>
</div>

<!-- MAIN -->
<div id="mainBox" class="hide">

<div class="card">
  <button onclick="showAdd()" id="addBtn">â• á€¡á€œá€¾á€°á€‘á€Šá€·á€º</button>
  <button onclick="showTable()">ğŸ“‹ á€…á€¬á€›á€„á€ºá€¸á€€á€¼á€Šá€·á€º</button>
  <button onclick="exportPNG()">ğŸ–¼ PNG</button>
  <button onclick="exportPDF()">ğŸ“„ PDF</button>
  <button class="red" onclick="logout()">Logout</button>
</div>

<!-- ADD -->
<div id="addBox" class="card hide">
  <h3 id="formTitle">á€¡á€œá€¾á€°á€…á€¬á€›á€„á€ºá€¸á€‘á€Šá€·á€º</h3>
  <input id="name" placeholder="á€¡á€™á€Šá€º">
  <input id="place" placeholder="á€”á€±á€›á€•á€º / á€”á€­á€¯á€„á€ºá€„á€¶">
  <input id="amount" type="number" placeholder="á€¡á€œá€¾á€°á€„á€½á€±" min="1">
  <input id="note" placeholder="á€™á€¾á€á€ºá€á€»á€€á€º">
  <button onclick="saveData()" id="saveBtn">á€á€­á€™á€ºá€¸á€™á€Šá€º</button>
</div>

<!-- TABLE -->
<div id="tableBox" class="card hide">
  <h3>á€¡á€œá€¾á€°á€›á€¾á€„á€ºá€…á€¬á€›á€„á€ºá€¸</h3>
  <table>
    <thead>
      <tr>
        <th>á€¡á€™á€Šá€º</th>
        <th>á€”á€±á€›á€•á€º</th>
        <th>á€„á€½á€±</th>
        <th>á€™á€¾á€á€ºá€á€»á€€á€º</th>
        <th id="actionCol">á€œá€¯á€•á€ºá€†á€±á€¬á€„á€ºá€á€»á€€á€º</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
  <div id="summary" class="small" style="margin-top:15px;"></div>
</div>

</div>

<footer>âœŠ Revolution Powered by LFM</footer>
</div>

<script>
// Firebase configuration - á€á€„á€·á€ºá€›á€²á€· Firebase project á€‘á€²á€€ configuration á€€á€­á€¯ á€’á€®á€”á€±á€›á€¬á€™á€¾á€¬ á€•á€¼á€„á€ºá€•á€±á€¸á€•á€«
const firebaseConfig = {
  apiKey: "AIzaSyBojMFTkLXmaFGqwq9tLKpXp-wXKqkN_no",
  authDomain: "lamp-88a25.firebaseapp.com",
  databaseURL: "https://lamp-88a25-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "lamp-88a25",
  storageBucket: "lamp-88a25.appspot.com", // Added this line
  messagingSenderId: "YOUR_MESSAGING_SENDER_ID", // Add this if needed
  appId: "YOUR_APP_ID" // Add this if needed
};

/* FIREBASE INITIALIZATION */
try {
  firebase.initializeApp(firebaseConfig);
  console.log("Firebase initialized successfully");
} catch (error) {
  console.error("Firebase initialization error:", error);
  document.getElementById("loginStatus").innerText = "Firebase á€á€»á€­á€á€ºá€†á€€á€ºá€™á€¾á€¯ á€™á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€•á€«";
  document.getElementById("loginStatus").style.color = "red";
}

const auth = firebase.auth();
const db = firebase.database();

/* STATE */
let role = "", editId = null;

/* UI ELEMENTS */
const loginBox = document.getElementById('loginBox');
const loadingBox = document.getElementById('loadingBox');
const mainBox = document.getElementById('mainBox');
const addBox = document.getElementById('addBox');
const tableBox = document.getElementById('tableBox');
const actionCol = document.getElementById('actionCol');
const tbody = document.getElementById('tbody');
const summary = document.getElementById('summary');
const formTitle = document.getElementById('formTitle');
const email = document.getElementById('email');
const password = document.getElementById('password');
const memberPin = document.getElementById('memberPin');
const name = document.getElementById('name');
const place = document.getElementById('place');
const amount = document.getElementById('amount');
const note = document.getElementById('note');

/* LOGIN FUNCTIONS */
function showLoading(show) {
  if (show) {
    loadingBox.classList.remove('hide');
    loginBox.classList.add('hide');
  } else {
    loadingBox.classList.add('hide');
  }
}

function adminLogin() {
  const emailVal = email.value.trim();
  const passwordVal = password.value.trim();
  
  if (!emailVal || !passwordVal) {
    alert("á€¡á€®á€¸á€™á€±á€¸á€œá€ºá€”á€¾á€„á€·á€º á€…á€€á€¬á€¸á€á€¾á€€á€º á€–á€¼á€Šá€·á€ºá€•á€«");
    return;
  }
  
  showLoading(true);
  
  auth.signInWithEmailAndPassword(emailVal, passwordVal)
    .then((userCredential) => {
      console.log("Admin login successful:", userCredential.user);
      role = "admin";
      enter();
    })
    .catch((error) => {
      console.error("Login error:", error);
      let errorMessage = "á€á€„á€ºá€›á€±á€¬á€€á€ºá€™á€¾á€¯ á€™á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€•á€«";
      
      switch (error.code) {
        case "auth/invalid-email":
          errorMessage = "á€¡á€®á€¸á€™á€±á€¸á€œá€º á€–á€±á€¬á€™á€á€º á€™á€¾á€¬á€¸á€šá€½á€„á€ºá€¸á€”á€±á€•á€«á€á€Šá€º";
          break;
        case "auth/user-not-found":
          errorMessage = "á€¡á€á€¯á€¶á€¸á€•á€¼á€¯á€á€° á€™á€á€½á€±á€·á€•á€«";
          break;
        case "auth/wrong-password":
          errorMessage = "á€…á€€á€¬á€¸á€á€¾á€€á€º á€™á€¾á€¬á€¸á€šá€½á€„á€ºá€¸á€”á€±á€•á€«á€á€Šá€º";
          break;
        case "auth/network-request-failed":
          errorMessage = "á€¡á€„á€ºá€á€¬á€”á€€á€º á€á€»á€­á€á€ºá€†á€€á€ºá€™á€¾á€¯ á€•á€¼á€¿á€”á€¬";
          break;
      }
      
      alert(errorMessage);
    })
    .finally(() => {
      showLoading(false);
    });
}

function memberLogin() {
  const pin = memberPin.value.trim();
  if (pin === "1111") {
    role = "member";
    enter();
  } else {
    alert("PIN á€”á€¶á€•á€«á€á€º á€™á€¾á€¬á€¸á€šá€½á€„á€ºá€¸á€”á€±á€•á€«á€á€Šá€º");
  }
}

function enter() {
  loginBox.classList.add("hide");
  mainBox.classList.remove("hide");
  
  if (role === "member") {
    actionCol.style.display = "none";
    document.getElementById("addBtn").style.display = "none";
  } else {
    actionCol.style.display = "";
    document.getElementById("addBtn").style.display = "";
  }
  
  loadData();
}

function logout() {
  auth.signOut().then(() => {
    location.reload();
  }).catch((error) => {
    console.error("Logout error:", error);
    location.reload();
  });
}

/* VIEW FUNCTIONS */
function hideAll() {
  addBox.classList.add("hide");
  tableBox.classList.add("hide");
}

function showAdd() {
  if (role !== "admin") {
    alert("Admin á€á€¬á€œá€»á€¾á€„á€º á€¡á€á€¯á€¶á€¸á€•á€¼á€¯á€”á€­á€¯á€„á€ºá€á€Šá€º");
    return;
  }
  
  editId = null;
  formTitle.innerText = "á€¡á€œá€¾á€°á€…á€¬á€›á€„á€ºá€¸á€‘á€Šá€·á€º";
  name.value = "";
  place.value = "";
  amount.value = "";
  note.value = "";
  
  hideAll();
  addBox.classList.remove("hide");
}

function showTable() {
  hideAll();
  tableBox.classList.remove("hide");
}

/* SAVE FUNCTION */
function saveData() {
  if (role !== "admin") {
    alert("Admin á€á€¬á€œá€»á€¾á€„á€º á€¡á€á€¯á€¶á€¸á€•á€¼á€¯á€”á€­á€¯á€„á€ºá€á€Šá€º");
    return;
  }
  
  const nameVal = name.value.trim();
  const placeVal = place.value.trim();
  const amountVal = amount.value.trim();
  const noteVal = note.value.trim();
  
  if (!nameVal || !placeVal || !amountVal) {
    alert("á€¡á€™á€Šá€ºáŠ á€”á€±á€›á€•á€ºá€”á€¾á€„á€·á€º á€¡á€œá€¾á€°á€„á€½á€± á€–á€¼á€Šá€·á€ºá€•á€«");
    return;
  }
  
  if (isNaN(amountVal) || parseInt(amountVal) <= 0) {
    alert("á€¡á€œá€¾á€°á€„á€½á€± á€™á€¾á€”á€ºá€€á€”á€ºá€…á€½á€¬ á€–á€¼á€Šá€·á€ºá€•á€«");
    return;
  }
  
  const saveBtn = document.getElementById("saveBtn");
  saveBtn.disabled = true;
  saveBtn.innerText = "á€á€­á€™á€ºá€¸á€†á€Šá€ºá€¸á€”á€±á€á€Šá€º...";
  
  const data = {
    name: nameVal,
    place: placeVal,
    amount: parseInt(amountVal),
    note: noteVal,
    time: Date.now(),
    timestamp: firebase.database.ServerValue.TIMESTAMP
  };
  
  let ref;
  if (editId) {
    ref = db.ref("donations/" + editId);
  } else {
    ref = db.ref("donations").push();
  }
  
  ref.set(data)
    .then(() => {
      alert("á€¡á€œá€¾á€°á€…á€¬á€›á€„á€ºá€¸ á€á€­á€™á€ºá€¸á€†á€Šá€ºá€¸á€á€¼á€„á€ºá€¸ á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€•á€«á€á€Šá€º");
      showTable();
    })
    .catch((error) => {
      console.error("Save error:", error);
      alert("á€á€­á€™á€ºá€¸á€†á€Šá€ºá€¸á€á€¼á€„á€ºá€¸ á€™á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€•á€«: " + error.message);
    })
    .finally(() => {
      saveBtn.disabled = false;
      saveBtn.innerText = "á€á€­á€™á€ºá€¸á€™á€Šá€º";
    });
}

/* LOAD DATA */
function loadData() {
  db.ref("donations").orderByChild("time").on("value", (snapshot) => {
    tbody.innerHTML = "";
    let total = 0;
    let count = 0;
    
    if (!snapshot.exists()) {
      tbody.innerHTML = `
        <tr>
          <td colspan="5" style="text-align:center; padding:20px;">
            á€¡á€œá€¾á€°á€…á€¬á€›á€„á€ºá€¸ á€™á€›á€¾á€­á€á€±á€¸á€•á€«
          </td>
        </tr>`;
      summary.innerText = "á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸ á€¡á€œá€¾á€°á€„á€½á€± = 0";
      return;
    }
    
    snapshot.forEach((childSnapshot) => {
      const data = childSnapshot.val();
      const key = childSnapshot.key;
      total += data.amount || 0;
      count++;
      
      const row = `
      <tr>
        <td>${escapeHtml(data.name || "")}</td>
        <td>${escapeHtml(data.place || "")}</td>
        <td>${formatNumber(data.amount || 0)}</td>
        <td>${escapeHtml(data.note || "")}</td>
        <td>
          ${role === "admin" ? `
          <button class="actionBtn" onclick="editData('${key}')">âœï¸</button>
          <button class="actionBtn red" onclick="deleteData('${key}')">âŒ</button>
          ` : ""}
        </td>
      </tr>`;
      
      tbody.innerHTML += row;
    });
    
    summary.innerHTML = `
      á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸ á€¡á€œá€¾á€°á€›á€¾á€„á€º: ${count} á€¦á€¸<br>
      á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸ á€¡á€œá€¾á€°á€„á€½á€±: ${formatNumber(total)} á€€á€»á€•á€º
    `;
  }, (error) => {
    console.error("Load data error:", error);
    tbody.innerHTML = `
      <tr>
        <td colspan="5" style="text-align:center; color:red; padding:20px;">
          á€’á€±á€á€¬á€–á€±á€¬á€ºá€•á€¼á€á€¼á€„á€ºá€¸ á€™á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€•á€«
        </td>
      </tr>`;
  });
}

/* EDIT / DELETE FUNCTIONS */
function editData(id) {
  db.ref("donations/" + id).once("value")
    .then((snapshot) => {
      if (snapshot.exists()) {
        const data = snapshot.val();
        editId = id;
        formTitle.innerText = "á€¡á€œá€¾á€°á€…á€¬á€›á€„á€ºá€¸á€•á€¼á€„á€ºá€†á€„á€ºá€™á€Šá€º";
        name.value = data.name || "";
        place.value = data.place || "";
        amount.value = data.amount || "";
        note.value = data.note || "";
        showAdd();
      }
    })
    .catch((error) => {
      console.error("Edit error:", error);
      alert("á€’á€±á€á€¬á€›á€šá€°á€á€¼á€„á€ºá€¸ á€™á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€•á€«");
    });
}

function deleteData(id) {
  if (confirm("á€¤á€¡á€œá€¾á€°á€…á€¬á€›á€„á€ºá€¸á€€á€­á€¯ á€–á€»á€€á€ºá€™á€¾á€¬ á€á€±á€á€»á€¬á€•á€«á€á€œá€¬á€¸?")) {
    db.ref("donations/" + id).remove()
      .then(() => {
        console.log("Data deleted successfully");
      })
      .catch((error) => {
        console.error("Delete error:", error);
        alert("á€–á€»á€€á€ºá€á€¼á€„á€ºá€¸ á€™á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€•á€«");
      });
  }
}

/* EXPORT FUNCTIONS */
function exportPNG() {
  showTable();
  setTimeout(() => {
    html2canvas(tableBox).then(canvas => {
      const link = document.createElement('a');
      link.download = 'LFM_Donations.png';
      link.href = canvas.toDataURL('image/png');
      link.click();
    });
  }, 500);
}

function exportPDF() {
  showTable();
  setTimeout(() => {
    html2canvas(tableBox).then(canvas => {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p', 'mm', 'a4');
      const imgData = canvas.toDataURL('image/png');
      const imgWidth = 190;
      const imgHeight = (canvas.height * imgWidth) / canvas.width;
      
      pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
      pdf.save('LFM_Donations_Report.pdf');
    });
  }, 500);
}

/* HELPER FUNCTIONS */
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function formatNumber(num) {
  return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

/* INITIAL SETUP */
window.onload = function() {
  // Check if user is already logged in
  auth.onAuthStateChanged((user) => {
    if (user) {
      role = "admin";
      enter();
    }
  });
};
</script>
</body>
</html>