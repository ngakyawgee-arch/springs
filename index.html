<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <title>LFM - Weekly Manager Pro (Visual Improved)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root { 
            --primary: #27ae60; 
            --danger: #e74c3c;
            --glass-dark: rgba(0, 0, 0, 0.85);
            --text: #ffffff;
        }
        body { 
            background: #1e272e;
            color: var(--text); 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            padding-bottom: 90px;
        }
        .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); padding: 14px 28px; border-radius: 12px; color: white; font-weight: bold; box-shadow: 0 10px 30px rgba(0,0,0,0.4); z-index: 9999; display: none; min-width: 280px; text-align: center; }
        .card { background: var(--glass-dark); padding: 15px; border-radius: 15px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1); }
        .hide { display: none !important; }
        .page { padding: 15px; max-width: 600px; margin: auto; }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: none; box-sizing: border-box; background: #333; color: white; }
        .btn { width: 100%; padding: 12px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; transition: 0.3s; }
        .btn-save { background: var(--primary); color: white; }
        .btn-expense { background: #d35400; color: white; }
        
        /* Bottom Nav */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: #111; display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid #333; }
        .nav-item { text-align: center; font-size: 12px; color: #888; cursor: pointer; }
        .nav-item.active { color: var(--primary); font-weight: bold; }

        /* Balance Grid */
        .balance-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .bal-card { background: var(--glass-dark); padding: 15px; border-radius: 15px; text-align: center; border: 1px solid rgba(255,255,255,0.05); }

        /* --- Beautiful Export Template --- */
        #exportExpenseArea { 
            position: fixed; left: -9999px; top: 0; width: 600px; 
            background: white; color: #2d3436; padding: 0; border-radius: 0;
            overflow: hidden; box-shadow: 0 0 20px rgba(0,0,0,0.2);
        }
        .exp-header { background: #27ae60; color: white; padding: 30px; text-align: center; }
        .exp-body { padding: 40px; }
        .exp-row { display: flex; justify-content: space-between; border-bottom: 1px solid #f1f1f1; padding: 15px 0; }
        .exp-label { font-weight: bold; color: #636e72; }
        .exp-value { font-weight: 800; color: #2d3436; font-size: 1.1em; }
        .exp-footer { background: #f9f9f9; padding: 20px; text-align: center; font-size: 12px; color: #b2bec3; border-top: 1px solid #eee; }
        .exp-amount-box { text-align: center; margin-top: 20px; padding: 20px; background: #eef9f1; border-radius: 10px; }
    </style>
</head>
<body>

    <div id="toast" class="toast"></div>

    <div id="loginPage" class="page">
        <div style="text-align: center; margin-top: 60px; margin-bottom: 40px;">
            <div style="width: 80px; height: 80px; background: var(--primary); border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 40px; margin-bottom: 15px;">ğŸ“Š</div>
            <h1 style="color: white; margin: 0;">LFM Pro</h1>
            <p style="color: #aaa;">Weekly Donation & Expense Manager</p>
        </div>
        <div class="card">
            <input type="email" id="email" placeholder="á€¡á€®á€¸á€™á€±á€¸á€œá€º">
            <input type="password" id="password" placeholder="á€œá€»á€¾á€­á€¯á€·á€á€¾á€€á€ºá€”á€¶á€•á€«á€á€º">
            <button class="btn btn-save" onclick="login()">LOGIN</button>
        </div>
    </div>

    <div id="mainApp" class="hide">
        <div class="page">
            <div class="balance-grid">
                <div class="bal-card">
                    <small style="color: #aaa;">á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸á€¡á€œá€¾á€°á€„á€½á€±</small>
                    <div id="globalIncome" style="color:#2ecc71; font-size: 1.2em; font-weight:bold; margin-top:5px;">0 á€˜á€á€º</div>
                </div>
                <div class="bal-card">
                    <small style="color: #aaa;">á€¡á€á€¯á€¶á€¸á€…á€›á€­á€á€º</small>
                    <div id="globalExpense" style="color:#ff7675; font-size: 1.2em; font-weight:bold; margin-top:5px;">0 á€˜á€á€º</div>
                </div>
            </div>
            <div class="card" style="text-align:center; background: linear-gradient(135deg, #1e272e 0%, #2f3640 100%);">
                <small style="color: #aaa;">á€œá€€á€ºá€€á€»á€”á€ºá€„á€½á€±</small>
                <div id="netBalance" style="font-size:28px; font-weight:bold; color: #fff; margin-top:5px;">0 á€˜á€á€º</div>
            </div>
        </div>

        <div id="incomeTab" class="page">
            <h3 style="color: var(--primary);">ğŸ’° á€¡á€œá€¾á€°á€›á€¾á€„á€ºá€¡á€á€…á€ºá€–á€¼á€Šá€·á€ºá€…á€½á€€á€ºá€›á€”á€º</h3>
            <div class="card">
                <input type="text" id="donorName" placeholder="á€¡á€œá€¾á€°á€›á€¾á€„á€ºá€¡á€™á€Šá€º">
                <input type="number" id="incomeAmount" placeholder="á€•á€™á€¬á€ (á€˜á€á€º)">
                <select id="incomeWeek"></select>
                <input type="date" id="incomeDate">
                <button class="btn btn-save" onclick="saveIncome()">á€á€­á€™á€ºá€¸á€†á€Šá€ºá€¸á€™á€Šá€º</button>
            </div>
        </div>

        <div id="expenseTab" class="page hide">
            <h3 style="color: #f39c12;">ğŸšš á€‘á€±á€¬á€€á€ºá€•á€­á€¯á€·á€¡á€œá€¾á€°á€™á€¾á€á€ºá€á€™á€ºá€¸á€¡á€á€…á€º</h3>
            <div class="card">
                <input type="text" id="expOrg" placeholder="á€¡á€–á€½á€²á€·á€¡á€™á€Šá€º">
                <input type="text" id="expActivity" placeholder="á€œá€¾á€¯á€•á€ºá€›á€¾á€¬á€¸á€™á€¾á€¯">
                <input type="text" id="expRegion" placeholder="á€’á€±á€">
                <input type="number" id="expAmount" placeholder="á€•á€™á€¬á€ (á€˜á€á€º)">
                <input type="date" id="expDate">
                <textarea id="expNote" rows="3" placeholder="á€™á€¾á€á€ºá€á€»á€€á€º..."></textarea>
                <button class="btn btn-expense" onclick="saveExpense()">á€™á€¾á€á€ºá€á€™á€ºá€¸á€á€„á€ºá€™á€Šá€º</button>
            </div>
        </div>

        <div id="historyTab" class="page hide">
            <h3>ğŸ“œ á€™á€¾á€á€ºá€á€™á€ºá€¸á€™á€»á€¬á€¸ <span id="historyCount" style="color: #777; font-size: 0.8em;"></span></h3>
            <input type="text" id="historySearch" placeholder="á€›á€¾á€¬á€–á€½á€±á€›á€”á€º (á€¡á€–á€½á€²á€·/á€’á€±á€)..." onkeyup="filterHistory()">
            <div id="expenseHistoryList"></div>
        </div>
    </div>

    <div id="exportExpenseArea">
        <div class="exp-header">
            <div style="font-size: 12px; opacity: 0.8; letter-spacing: 2px; margin-bottom: 5px;">OFFICIAL RECEIPT</div>
            <div style="font-size: 28px; font-weight: 800; text-transform: uppercase;">LFM á€‘á€±á€¬á€€á€ºá€•á€­á€¯á€·á€™á€¾á€á€ºá€á€™á€ºá€¸</div>
        </div>
        <div class="exp-body">
            <div class="exp-row">
                <span class="exp-label">á€¡á€–á€½á€²á€·á€¡á€™á€Šá€º</span>
                <span class="exp-value" id="outOrg"></span>
            </div>
            <div class="exp-row">
                <span class="exp-label">á€œá€¾á€¯á€•á€ºá€›á€¾á€¬á€¸á€™á€¾á€¯</span>
                <span class="exp-value" id="outAct"></span>
            </div>
            <div class="exp-row">
                <span class="exp-label">á€’á€±á€</span>
                <span class="exp-value" id="outReg"></span>
            </div>
            <div class="exp-row">
                <span class="exp-label">á€”á€±á€·á€…á€½á€²</span>
                <span class="exp-value" id="outDate"></span>
            </div>
            <div class="exp-amount-box">
                <div style="font-size: 14px; color: #27ae60; font-weight: bold;">á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸á€œá€¾á€°á€’á€«á€”á€ºá€¸á€„á€½á€±</div>
                <div style="font-size: 32px; font-weight: 900; color: #2d3436;"><span id="outAmt"></span> <small style="font-size: 16px;">THB</small></div>
            </div>
            <div style="margin-top: 25px; font-style: italic; color: #636e72; font-size: 14px; text-align: center;">
                "á€•á€±á€¸á€€á€™á€ºá€¸á€á€¼á€„á€ºá€¸á€á€Šá€º á€•á€»á€±á€¬á€ºá€›á€½á€¾á€„á€ºá€á€¼á€„á€ºá€¸á€á€…á€ºá€™á€»á€­á€¯á€¸á€–á€¼á€…á€ºá€á€Šá€º"
            </div>
        </div>
        <div class="exp-footer">
            Generated via LFM Weekly Manager Pro â€¢ 2026 Reports
        </div>
    </div>

    <nav id="bottomNav" class="bottom-nav hide">
        <div class="nav-item active" onclick="switchTab('incomeTab', this)">ğŸ’°<br>á€¡á€œá€¾á€°á€›á€¾á€„á€º</div>
        <div class="nav-item" onclick="switchTab('expenseTab', this)">ğŸšš<br>á€‘á€±á€¬á€€á€ºá€•á€­á€¯á€·</div>
        <div class="nav-item" onclick="switchTab('historyTab', this)">ğŸ“œ<br>á€™á€¾á€á€ºá€á€™á€ºá€¸</div>
        <div class="nav-item" onclick="logout()">ğŸšª<br>á€‘á€½á€€á€ºá€›á€”á€º</div>
    </nav>

    <script>
        // *** á€á€„á€ºá Firebase API Keys á€™á€»á€¬á€¸á€€á€­á€¯ á€¤á€”á€±á€›á€¬á€á€½á€„á€º á€¡á€…á€¬á€¸á€‘á€­á€¯á€¸á€•á€« ***
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let totalInc = 0;
        let totalExp = 0;

        // Auto-generate Week numbers
        const weekSelect = document.getElementById('incomeWeek');
        for (let i = 1; i <= 100; i++) {
            let opt = document.createElement('option');
            opt.value = `Week-${i}`;
            opt.textContent = `á€¡á€•á€á€ºá€…á€‰á€º ${i}`;
            weekSelect.appendChild(opt);
        }

        function showToast(msg, type = "success") {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.style.background = type === "success" ? "#27ae60" : "#e74c3c";
            t.style.display = "block";
            setTimeout(() => t.style.display = "none", 2800);
        }

        function setupRealtimeListeners() {
            // Income Listener
            db.ref('weekly_donations').on('value', snap => {
                totalInc = 0;
                snap.forEach(week => {
                    week.forEach(child => {
                        totalInc += parseFloat(child.val().amount || 0);
                    });
                });
                document.getElementById('globalIncome').textContent = totalInc.toLocaleString() + " á€˜á€á€º";
                updateNet();
            });

            // Expense Listener
            db.ref('expenses').on('value', snap => {
                totalExp = 0;
                const list = document.getElementById('expenseHistoryList');
                list.innerHTML = '';
                let arr = [];
                snap.forEach(child => {
                    const v = child.val();
                    arr.push({key: child.key, ...v});
                    totalExp += parseFloat(v.amount || 0);
                });
                
                arr.reverse().forEach(item => {
                    list.insertAdjacentHTML('beforeend', `
                        <div class="card" style="border-left: 4px solid #f39c12;">
                            <div style="display:flex; justify-content: space-between; align-items: flex-start;">
                                <h3 style="margin:0;color:#2ecc71;">${item.org}</h3>
                                <span style="font-size: 11px; color: #777;">${item.date}</span>
                            </div>
                            <p style="margin: 8px 0; color: #ddd;">${item.activity || ''} <br><small style="color: #888;">ğŸ“ ${item.region || '-'}</small></p>
                            <p style="font-size: 1.1em; font-weight: bold; margin: 0;">${parseFloat(item.amount).toLocaleString()} á€˜á€á€º</p>
                            <div style="display:flex; gap:10px; margin-top: 15px;">
                                <button class="btn btn-save" style="padding: 8px; font-size: 12px; flex: 1;" onclick="exportExpensePNG('${item.key}')">ğŸ“· PNG á€‘á€¯á€á€ºá€›á€”á€º</button>
                                <button class="btn" style="background:#444; color:white; padding: 8px; font-size: 12px; flex: 1;" onclick="deleteExpense('${item.key}')">á€–á€»á€€á€ºá€™á€Šá€º</button>
                            </div>
                        </div>
                    `);
                });
                document.getElementById('globalExpense').textContent = totalExp.toLocaleString() + " á€˜á€á€º";
                document.getElementById('historyCount').textContent = `(${arr.length})`;
                updateNet();
            });
        }

        function updateNet() {
            const net = totalInc - totalExp;
            const el = document.getElementById('netBalance');
            el.textContent = net.toLocaleString() + " á€˜á€á€º";
            el.style.color = net >= 0 ? "#2ecc71" : "#e74c3c";
        }

        async function login() {
            const email = document.getElementById('email').value.trim();
            const pass = document.getElementById('password').value;
            if(!email || !pass) return showToast("Email á€”á€¾á€„á€·á€º Password á€–á€¼á€Šá€·á€ºá€•á€«", "error");
            try {
                await auth.signInWithEmailAndPassword(email, pass);
                showToast("Login á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€á€Šá€º");
            } catch (e) {
                showToast("á€¡á€á€»á€€á€ºá€¡á€œá€€á€ºá€™á€¾á€¬á€¸á€šá€½á€„á€ºá€¸á€”á€±á€á€Šá€º", "error");
            }
        }

        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('loginPage').classList.add('hide');
                document.getElementById('mainApp').classList.remove('hide');
                document.getElementById('bottomNav').classList.remove('hide');
                document.getElementById('incomeDate').valueAsDate = new Date();
                document.getElementById('expDate').valueAsDate = new Date();
                setupRealtimeListeners();
            }
        });

        function switchTab(id, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.add('hide'));
            document.getElementById(id).classList.remove('hide');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
        }

        function filterHistory() {
            const query = document.getElementById('historySearch').value.toLowerCase();
            const cards = document.querySelectorAll('#expenseHistoryList .card');
            cards.forEach(c => {
                c.style.display = c.textContent.toLowerCase().includes(query) ? "" : "none";
            });
        }

        function saveIncome() {
            const name = document.getElementById('donorName').value.trim();
            const amt = document.getElementById('incomeAmount').value;
            const week = document.getElementById('incomeWeek').value;
            const date = document.getElementById('incomeDate').value;
            if(!name || !amt) return showToast("á€¡á€œá€¾á€°á€›á€¾á€„á€ºá€¡á€™á€Šá€ºá€”á€¾á€„á€·á€º á€•á€™á€¬á€á€–á€¼á€Šá€·á€ºá€•á€«", "error");

            db.ref(`weekly_donations/${week}`).push({ donorName: name, amount: amt, date })
            .then(() => {
                showToast("á€¡á€œá€¾á€°á€›á€¾á€„á€ºá€…á€¬á€›á€„á€ºá€¸ á€á€­á€™á€ºá€¸á€†á€Šá€ºá€¸á€•á€¼á€®á€¸");
                document.getElementById('donorName').value = '';
                document.getElementById('incomeAmount').value = '';
            });
        }

        function saveExpense() {
            const org = document.getElementById('expOrg').value.trim();
            const amt = document.getElementById('expAmount').value;
            if(!org || !amt) return showToast("á€¡á€–á€½á€²á€·á€¡á€™á€Šá€ºá€”á€¾á€„á€·á€º á€•á€™á€¬á€á€–á€¼á€Šá€·á€ºá€•á€«", "error");

            const data = {
                org,
                activity: document.getElementById('expActivity').value.trim(),
                region: document.getElementById('expRegion').value.trim(),
                amount: amt,
                date: document.getElementById('expDate').value,
                note: document.getElementById('expNote').value.trim()
            };
            db.ref('expenses').push(data).then(() => {
                showToast("á€™á€¾á€á€ºá€á€™á€ºá€¸á€á€­á€™á€ºá€¸á€†á€Šá€ºá€¸á€•á€¼á€®á€¸");
                // Clear inputs
                ['expOrg', 'expActivity', 'expRegion', 'expAmount', 'expNote'].forEach(id => document.getElementById(id).value = '');
            });
        }

        function deleteExpense(key) {
            if(confirm("á€¤á€™á€¾á€á€ºá€á€™á€ºá€¸á€€á€­á€¯ á€¡á€•á€¼á€®á€¸á€á€­á€¯á€„á€ºá€–á€»á€€á€ºá€™á€¾á€¬ á€á€±á€á€»á€¬á€•á€«á€á€œá€¬á€¸?")) {
                db.ref(`expenses/${key}`).remove()
                .then(() => showToast("á€–á€»á€€á€ºá€á€­á€™á€ºá€¸á€•á€¼á€®á€¸á€•á€«á€•á€¼á€®"));
            }
        }

        function exportExpensePNG(key) {
            showToast("á€•á€¯á€¶á€‘á€¯á€á€ºá€”á€±á€á€Šá€ºáŠ á€á€á€…á€±á€¬á€„á€·á€ºá€•á€«...", "success");
            db.ref(`expenses/${key}`).once('value', snap => {
                const v = snap.val();
                document.getElementById('outOrg').textContent = v.org;
                document.getElementById('outAct').textContent = v.activity || '-';
                document.getElementById('outReg').textContent = v.region || '-';
                document.getElementById('outAmt').textContent = parseFloat(v.amount).toLocaleString();
                document.getElementById('outDate').textContent = v.date;

                const area = document.getElementById('exportExpenseArea');
                area.style.left = "0"; // Make it visible for html2canvas
                
                html2canvas(area, { scale: 2 }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `LFM_Receipt_${v.org}_${v.date}.png`;
                    link.href = canvas.toDataURL("image/png");
                    link.click();
                    area.style.left = "-9999px"; // Hide again
                    showToast("á€•á€¯á€¶á€‘á€¯á€á€ºá€šá€°á€™á€¾á€¯ á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€á€Šá€º");
                });
            });
        }

        function logout() {
            if(confirm("á€¡á€€á€±á€¬á€„á€·á€ºá€™á€¾ á€‘á€½á€€á€ºá€™á€¾á€¬á€œá€¬á€¸?")) {
                auth.signOut().then(() => location.reload());
            }
        }
    </script>
</body>
</html>
