<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <title>LFM - Weekly Manager Pro (Final Fixed)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root { 
            --primary: #27ae60; 
            --danger: #e74c3c;
            --glass-dark: rgba(20, 20, 20, 0.95);
            --text: #ffffff;
        }
        body { 
            background: #0f172a;
            color: var(--text); 
            font-family: 'Pyidaungsu', sans-serif; 
            margin: 0; 
            padding-bottom: 90px;
        }
        .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); padding: 14px 28px; border-radius: 12px; color: white; font-weight: bold; box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 9999; display: none; min-width: 250px; text-align: center; }
        .card { background: var(--glass-dark); padding: 18px; border-radius: 16px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.08); }
        .hide { display: none !important; }
        .page { padding: 15px; max-width: 550px; margin: auto; }
        input, select, textarea { width: 100%; padding: 14px; margin: 8px 0; border-radius: 10px; border: 1px solid #334155; background: #1e293b; color: white; font-size: 16px; box-sizing: border-box; }
        .btn { width: 100%; padding: 14px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; transition: 0.2s active; font-size: 16px; }
        .btn-save { background: var(--primary); color: white; }
        .btn-expense { background: #ea580c; color: white; }
        
        /* Nav */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: #020617; display: flex; justify-content: space-around; padding: 12px 0; border-top: 1px solid #1e293b; }
        .nav-item { text-align: center; font-size: 11px; color: #64748b; cursor: pointer; transition: 0.3s; }
        .nav-item.active { color: var(--primary); font-weight: bold; transform: scale(1.1); }

        /* Stats */
        .balance-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px; }
        .bal-card { background: #1e293b; padding: 15px; border-radius: 16px; text-align: center; border: 1px solid rgba(255,255,255,0.05); }

        /* Table Styles */
        .table-container { overflow-x: auto; margin-top: 15px; border-radius: 16px; background: #1e293b; padding: 5px; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; min-width: 500px; }
        th { background: #2d3a4f; color: white; padding: 12px 8px; font-weight: 600; text-align: left; }
        td { padding: 10px 8px; border-bottom: 1px solid #334155; color: #e2e8f0; }
        tr:last-child td { border-bottom: none; }
        .donor-total-row { background: #27ae6033; font-weight: bold; border-top: 2px solid #27ae60; }
        .donor-total-row td { color: #22c55e; }
        .btn-small { padding: 6px 12px; font-size: 12px; margin: 2px; width: auto; }

        /* --- Export Template Design --- */
        #exportExpenseArea, #exportIncomeArea { 
            position: fixed; left: -9999px; top: 0; width: 550px; 
            background: #ffffff; color: #1e293b; padding: 0;
        }
        .exp-header { background: #10b981; color: white; padding: 40px 20px; text-align: center; border-bottom: 5px solid #059669; }
        .exp-body { padding: 30px; background: white; }
        .exp-row { display: flex; justify-content: space-between; border-bottom: 1px dashed #e2e8f0; padding: 15px 5px; }
        .exp-label { color: #64748b; font-weight: 500; }
        .exp-value { color: #0f172a; font-weight: 700; font-size: 17px; }
        .exp-amount-wrap { margin-top: 30px; background: #f0fdf4; padding: 25px; border-radius: 15px; text-align: center; border: 2px solid #dcfce7; }
        .exp-footer { padding: 20px; text-align: center; font-size: 11px; color: #94a3b8; background: #f8fafc; }

        /* Income Table Export */
        .income-export-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .income-export-table th { background: #10b981; color: white; padding: 12px; }
        .income-export-table td { padding: 10px; border: 1px solid #e2e8f0; color: #1e293b; }
    </style>
</head>
<body>

    <div id="toast" class="toast"></div>

    <div id="loginPage" class="page">
        <div style="text-align: center; margin-top: 80px; margin-bottom: 40px;">
            <div style="font-size: 60px; margin-bottom: 10px;">ğŸ›¡ï¸</div>
            <h1 style="margin: 0; letter-spacing: 1px;">LFM PRO</h1>
            <p style="color: #64748b;">Financial Management System</p>
        </div>
        <div class="card">
            <input type="email" id="email" placeholder="á€¡á€®á€¸á€™á€±á€¸á€œá€º">
            <input type="password" id="password" placeholder="á€œá€»á€¾á€­á€¯á€·á€á€¾á€€á€ºá€”á€¶á€•á€«á€á€º">
            <button class="btn btn-save" onclick="login()">á€¡á€€á€±á€¬á€„á€·á€ºá€á€„á€ºá€™á€Šá€º</button>
        </div>
    </div>

    <div id="mainApp" class="hide">
        <div class="page">
            <div class="balance-grid">
                <div class="bal-card">
                    <small style="color: #94a3b8;">á€¡á€œá€¾á€°á€„á€½á€±á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸</small>
                    <div id="globalIncome" style="color:#22c55e; font-weight:800; font-size: 1.1em; margin-top:4px;">0</div>
                </div>
                <div class="bal-card">
                    <small style="color: #94a3b8;">á€¡á€á€¯á€¶á€¸á€…á€›á€­á€á€º</small>
                    <div id="globalExpense" style="color:#ef4444; font-weight:800; font-size: 1.1em; margin-top:4px;">0</div>
                </div>
            </div>
            <div class="card" style="text-align:center; background: linear-gradient(to right, #1e293b, #0f172a);">
                <small style="color: #94a3b8;">á€œá€€á€ºá€€á€»á€”á€ºá€„á€½á€±</small>
                <div id="netBalance" style="font-size:26px; font-weight:900; margin-top:5px;">0 á€˜á€á€º</div>
            </div>
        </div>

        <div id="incomeTab" class="page">
            <h3>ğŸ’° á€¡á€œá€¾á€°á€›á€¾á€„á€ºá€…á€¬á€›á€„á€ºá€¸á€á€½á€„á€ºá€¸á€›á€”á€º</h3>
            <div class="card">
                <input type="text" id="donorName" placeholder="á€¡á€œá€¾á€°á€›á€¾á€„á€ºá€¡á€™á€Šá€º">
                <input type="number" id="incomeAmount" placeholder="á€•á€™á€¬á€ (á€˜á€á€º)">
                <select id="incomeWeek"></select>
                <input type="date" id="incomeDate">
                <button class="btn btn-save" onclick="saveIncome()">á€’á€±á€á€¬á€á€­á€™á€ºá€¸á€™á€Šá€º</button>
            </div>
            
            <h3>ğŸ“Š á€¡á€œá€¾á€°á€„á€½á€±á€‡á€šá€¬á€¸á€á€»á€¯á€•á€º</h3>
            <div class="card" style="padding: 10px;">
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <select id="filterWeek" style="flex: 2;" onchange="renderIncomeTable()">
                        <option value="">á€¡á€¬á€¸á€œá€¯á€¶á€¸</option>
                    </select>
                    <button class="btn btn-save btn-small" style="flex: 1; margin:0;" onclick="exportIncomeTablePNG()">ğŸ“· á€‡á€šá€¬á€¸á€•á€¯á€¶á€‘á€¯á€á€º</button>
                </div>
                <div id="incomeTableContainer" class="table-container">
                    <table id="incomeTable">
                        <thead>
                            <tr><th>á€¡á€•á€á€º</th><th>á€¡á€œá€¾á€°á€›á€¾á€„á€º</th><th>á€„á€½á€±á€•á€™á€¬á€</th><th>á€›á€€á€ºá€…á€½á€²</th><th>á€œá€¯á€•á€ºá€†á€±á€¬á€„á€ºá€á€»á€€á€º</th></tr>
                        </thead>
                        <tbody id="incomeTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="expenseTab" class="page hide">
            <h3>ğŸšš á€‘á€±á€¬á€€á€ºá€•á€­á€¯á€·á€…á€›á€­á€á€ºá€™á€¾á€á€ºá€á€™á€ºá€¸</h3>
            <div class="card">
                <input type="text" id="expOrg" placeholder="á€œá€€á€ºá€á€¶á€á€Šá€·á€ºá€¡á€–á€½á€²á€·á€¡á€™á€Šá€º">
                <input type="text" id="expActivity" placeholder="á€œá€¾á€¯á€•á€ºá€›á€¾á€¬á€¸á€™á€¾á€¯á€¡á€™á€»á€­á€¯á€¸á€¡á€…á€¬á€¸">
                <input type="text" id="expRegion" placeholder="á€’á€±á€/á€”á€±á€›á€¬">
                <input type="number" id="expAmount" placeholder="á€œá€¾á€°á€’á€«á€”á€ºá€¸á€„á€½á€± (á€˜á€á€º)">
                <input type="date" id="expDate">
                <textarea id="expNote" rows="2" placeholder="á€¡á€á€¼á€¬á€¸á€™á€¾á€á€ºá€á€»á€€á€ºá€™á€»á€¬á€¸..."></textarea>
                <button class="btn btn-expense" onclick="saveExpense()">á€™á€¾á€á€ºá€á€™á€ºá€¸á€á€„á€ºá€™á€Šá€º</button>
            </div>
        </div>

        <div id="historyTab" class="page hide">
            <div style="display:flex; justify-content: space-between; align-items: center;">
                <h3>ğŸ“œ á€™á€¾á€á€ºá€á€™á€ºá€¸á€Ÿá€±á€¬á€„á€ºá€¸á€™á€»á€¬á€¸</h3>
                <span id="historyCount" style="background:#334155; padding:4px 10px; border-radius:20px; font-size:12px;">0</span>
            </div>
            <input type="text" id="historySearch" placeholder="á€¡á€–á€½á€²á€·á€¡á€™á€Šá€ºá€–á€¼á€„á€·á€º á€›á€¾á€¬á€–á€½á€±á€›á€”á€º..." onkeyup="filterHistory()">
            <div id="expenseHistoryList"></div>
        </div>
    </div>

    <div id="exportExpenseArea">
        <div class="exp-header">
            <div style="letter-spacing: 3px; font-size: 13px; opacity: 0.9;">LFM ASSISTANCE</div>
            <div style="font-size: 30px; font-weight: 900; margin-top: 5px;">á€‘á€±á€¬á€€á€ºá€•á€­á€¯á€·á€œá€¾á€°á€’á€«á€”á€ºá€¸á€™á€¾á€¯</div>
        </div>
        <div class="exp-body">
            <div class="exp-row">
                <span class="exp-label">á€œá€€á€ºá€á€¶á€á€°/á€¡á€–á€½á€²á€·</span>
                <span class="exp-value" id="outOrg"></span>
            </div>
            <div class="exp-row">
                <span class="exp-label">á€œá€¾á€¯á€•á€ºá€›á€¾á€¬á€¸á€™á€¾á€¯</span>
                <span class="exp-value" id="outAct"></span>
            </div>
            <div class="exp-row">
                <span class="exp-label">á€’á€±á€</span>
                <span class="exp-value" id="outReg"></span>
            </div>
            <div class="exp-row">
                <span class="exp-label">á€›á€€á€ºá€…á€½á€²</span>
                <span class="exp-value" id="outDate"></span>
            </div>
            <div class="exp-amount-wrap">
                <div style="color: #10b981; font-weight: bold; font-size: 14px;">á€œá€¾á€°á€’á€«á€”á€ºá€¸á€„á€½á€±á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸</div>
                <div style="font-size: 34px; font-weight: 900; color: #1e293b; margin-top: 5px;"><span id="outAmt"></span> <small style="font-size: 15px;">THB</small></div>
            </div>
        </div>
        <div class="exp-footer">
            á€¤á€™á€¾á€á€ºá€á€™á€ºá€¸á€€á€­á€¯ LFM Weekly Manager á€™á€¾ á€‘á€¯á€á€ºá€•á€±á€¸á€•á€«á€á€Šá€ºá‹
        </div>
    </div>

    <div id="exportIncomeArea">
        <div class="exp-header">
            <div style="letter-spacing: 3px; font-size: 13px; opacity: 0.9;">LFM DONATION</div>
            <div style="font-size: 30px; font-weight: 900; margin-top: 5px;">á€¡á€œá€¾á€°á€„á€½á€±á€…á€¬á€›á€„á€ºá€¸á€á€»á€¯á€•á€º</div>
        </div>
        <div class="exp-body">
            <table class="income-export-table" id="incomeExportTable">
                <thead>
                    <tr><th>á€¡á€•á€á€º</th><th>á€¡á€œá€¾á€°á€›á€¾á€„á€º</th><th>á€„á€½á€±á€•á€™á€¬á€</th><th>á€›á€€á€ºá€…á€½á€²</th></tr>
                </thead>
                <tbody id="incomeExportBody"></tbody>
            </table>
            <div class="exp-amount-wrap">
                <div style="color: #10b981; font-weight: bold; font-size: 14px;">á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸á€¡á€œá€¾á€°á€„á€½á€±</div>
                <div style="font-size: 34px; font-weight: 900; color: #1e293b; margin-top: 5px;"><span id="outIncomeTotal"></span> <small style="font-size: 15px;">THB</small></div>
            </div>
        </div>
        <div class="exp-footer">
            á€¤á€™á€¾á€á€ºá€á€™á€ºá€¸á€€á€­á€¯ LFM Weekly Manager á€™á€¾ á€‘á€¯á€á€ºá€•á€±á€¸á€•á€«á€á€Šá€ºá‹
        </div>
    </div>

    <nav id="bottomNav" class="bottom-nav hide">
        <div class="nav-item active" onclick="switchTab('incomeTab', this)">ğŸ’°<br>á€¡á€œá€¾á€°á€›á€¾á€„á€º</div>
        <div class="nav-item" onclick="switchTab('expenseTab', this)">ğŸšš<br>á€‘á€±á€¬á€€á€ºá€•á€­á€¯á€·</div>
        <div class="nav-item" onclick="historyClick(this)">ğŸ“œ<br>á€™á€¾á€á€ºá€á€™á€ºá€¸</div>
        <div class="nav-item" onclick="logout()">ğŸšª<br>á€‘á€½á€€á€ºá€›á€”á€º</div>
    </nav>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyBojMFTkLXmaFGqwq9tLKpXp-wXKqkN_no",
            authDomain: "lamp-88a25.firebaseapp.com",
            databaseURL: "https://lamp-88a25-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "lamp-88a25",
            storageBucket: "lamp-88a25.firebasestorage.app",
            messagingSenderId: "151980650338",
            appId: "1:151980650338:web:0e4e02c09d0ba58a16c63b"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let totalInc = 0;
        let totalExp = 0;
        let incomeData = []; // Store all income data for table

        // Auto Weeks
        const ws = document.getElementById('incomeWeek');
        const filterWeek = document.getElementById('filterWeek');
        for (let i = 1; i <= 100; i++) {
            let o = document.createElement('option');
            o.value = `Week-${i}`; o.textContent = `á€¡á€•á€á€ºá€…á€‰á€º ${i}`;
            ws.appendChild(o);
            
            let f = document.createElement('option');
            f.value = `Week-${i}`; f.textContent = `á€¡á€•á€á€ºá€…á€‰á€º ${i}`;
            filterWeek.appendChild(f);
        }

        function showToast(m, type="success") {
            const t = document.getElementById('toast');
            t.textContent = m;
            t.style.background = type === "success" ? "#10b981" : "#ef4444";
            t.style.display = "block";
            setTimeout(() => t.style.display = "none", 2500);
        }

        function renderIncomeTable() {
            const filter = document.getElementById('filterWeek').value;
            const tbody = document.getElementById('incomeTableBody');
            tbody.innerHTML = '';
            let filteredData = filter ? incomeData.filter(item => item.week === filter) : incomeData;
            
            filteredData.forEach(item => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${item.week}</td>
                    <td>${item.donorName}</td>
                    <td>${parseFloat(item.amount).toLocaleString()} á€˜á€á€º</td>
                    <td>${item.date}</td>
                    <td><button class="btn btn-small" style="background:#ef4444; padding:4px 8px;" onclick="deleteIncome('${item.week}', '${item.id}')">á€–á€»á€€á€º</button></td>
                `;
            });
            
            // Add total row
            if (filteredData.length > 0) {
                const total = filteredData.reduce((sum, item) => sum + parseFloat(item.amount), 0);
                const totalRow = tbody.insertRow();
                totalRow.className = 'donor-total-row';
                totalRow.innerHTML = `<td colspan="2" style="text-align:right;">á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸</td><td>${total.toLocaleString()} á€˜á€á€º</td><td colspan="2"></td>`;
            }
        }

        function deleteIncome(week, id) {
            if(confirm("á€¤á€¡á€œá€¾á€°á€„á€½á€±á€€á€­á€¯ á€–á€»á€€á€ºá€›á€”á€º á€á€±á€á€»á€¬á€•á€«á€á€œá€¬á€¸?")) {
                db.ref(`weekly_donations/${week}/${id}`).remove();
            }
        }

        function syncData() {
            // Income data
            db.ref('weekly_donations').on('value', s => {
                totalInc = 0;
                incomeData = [];
                s.forEach(w => { 
                    const week = w.key;
                    w.forEach(c => { 
                        const val = c.val();
                        totalInc += parseFloat(val.amount || 0);
                        incomeData.push({
                            id: c.key,
                            week: week,
                            donorName: val.donorName,
                            amount: val.amount,
                            date: val.date
                        });
                    }); 
                });
                // Sort by date (newest first)
                incomeData.sort((a, b) => (a.date < b.date) ? 1 : -1);
                document.getElementById('globalIncome').textContent = totalInc.toLocaleString();
                renderIncomeTable();
                updateNet();
            });

            // Expense data
            db.ref('expenses').on('value', s => {
                totalExp = 0;
                const list = document.getElementById('expenseHistoryList');
                list.innerHTML = '';
                let arr = [];
                s.forEach(c => {
                    const v = c.val();
                    arr.push({id: c.key, ...v});
                    totalExp += parseFloat(v.amount || 0);
                });
                arr.reverse().forEach(item => {
                    list.insertAdjacentHTML('beforeend', `
                        <div class="card" style="border-right: 4px solid #ea580c;">
                            <div style="display:flex; justify-content: space-between;">
                                <b style="color:#22c55e; font-size:1.1em;">${item.org}</b>
                                <span style="font-size:12px; color:#64748b;">${item.date}</span>
                            </div>
                            <div style="margin: 8px 0; font-size:14px; color:#cbd5e1;">${item.activity} - ${item.region}</div>
                            <div style="font-weight:bold; font-size:16px;">${parseFloat(item.amount).toLocaleString()} á€˜á€á€º</div>
                            <div style="display:flex; gap:8px; margin-top:12px;">
                                <button class="btn btn-save" style="flex:1; padding:8px; font-size:12px;" onclick="exportPNG('${item.id}')">ğŸ“· á€•á€¯á€¶á€‘á€¯á€á€ºá€›á€”á€º</button>
                                <button class="btn" style="flex:1; padding:8px; font-size:12px; background:#334155; color:white;" onclick="delExp('${item.id}')">á€–á€»á€€á€ºá€™á€Šá€º</button>
                            </div>
                        </div>
                    `);
                });
                document.getElementById('globalExpense').textContent = totalExp.toLocaleString();
                document.getElementById('historyCount').textContent = arr.length;
                updateNet();
            });
        }

        function updateNet() {
            const net = totalInc - totalExp;
            const nEl = document.getElementById('netBalance');
            nEl.textContent = net.toLocaleString() + " á€˜á€á€º";
            nEl.style.color = net >= 0 ? "#22c55e" : "#ef4444";
        }

        async function login() {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            try { await auth.signInWithEmailAndPassword(e, p); } 
            catch { showToast("á€¡á€á€»á€€á€ºá€¡á€œá€€á€ºá€™á€¾á€¬á€¸á€šá€½á€„á€ºá€¸á€”á€±á€á€Šá€º", "error"); }
        }

        auth.onAuthStateChanged(u => {
            if (u) {
                document.getElementById('loginPage').classList.add('hide');
                document.getElementById('mainApp').classList.remove('hide');
                document.getElementById('bottomNav').classList.remove('hide');
                document.getElementById('incomeDate').valueAsDate = new Date();
                document.getElementById('expDate').valueAsDate = new Date();
                syncData();
            }
        });

        function switchTab(id, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.add('hide'));
            document.getElementById(id).classList.remove('hide');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
        }

        function historyClick(el) {
            switchTab('historyTab', el);
        }

        function saveIncome() {
            const name = document.getElementById('donorName').value;
            const amt = document.getElementById('incomeAmount').value;
            const week = document.getElementById('incomeWeek').value;
            const date = document.getElementById('incomeDate').value;
            