<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <title>á€–á€­á€¯á€¸á€…á€±á€¬á€„á€·á€ºá€á€±á€¬á€„á€ºá€™á€®á€¸á€¡á€­á€™á€º (LFM)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#1e8f4d">
    <meta name="description" content="á€á€±á€¬á€ºá€œá€¾á€”á€ºá€›á€±á€¸ á€¡á€œá€¾á€°á€›á€¾á€„á€ºá€™á€¾á€á€ºá€á€™á€ºá€¸ - Offline á€á€¯á€¶á€¸á€”á€­á€¯á€„á€ºá€á€±á€¬ App">
    
    <!-- Icons -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <!-- Libraries -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <style>
        :root {
            --primary: #1e8f4d;
            --primary-dark: #167a3f;
            --dark: #0d0d0d;
            --card: #1a1a1a;
            --card-light: #222222;
            --danger: #dc3545;
            --warning: #ffc107;
            --success: #28a745;
        }
        body {
            background: var(--dark);
            color: white;
            font-family: 'Noto Sans Myanmar', system-ui, sans-serif;
            margin: 0;
            padding: 0;
        }
        .hide { display: none !important; }
        .app-container { padding: 15px; padding-bottom: 90px; }
        .app-header {
            background: var(--card);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
        }
        .app-title { color: var(--primary); font-size: 1.8rem; margin: 0; }
        .card {
            background: var(--card);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 16px;
        }
        input, textarea {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            border: 1px solid #444;
            background: #222;
            color: white;
            font-size: 1rem;
        }
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            margin: 8px 0;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: #444; color: white; }
        .btn-success { background: var(--success); color: white; }
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card);
            display: flex;
            padding: 10px;
            border-top: 1px solid #333;
        }
        .nav-btn {
            flex: 1;
            background: none;
            border: none;
            color: #aaa;
            font-size: 0.8rem;
            text-align: center;
        }
        .nav-btn.active { color: var(--primary); }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #333;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 1000;
            max-width: 90%;
        }
        .d-flex { display: flex; gap: 12px; }
        .justify-between { justify-content: space-between; }
        .text-success { color: var(--success); }
        .text-danger { color: var(--danger); }
        .text-warning { color: var(--warning); }
    </style>
</head>
<body>

<div class="app-container">

    <!-- Login Page -->
    <div id="loginPage">
        <div class="app-header">
            <h1 class="app-title">âœŠ á€–á€­á€¯á€¸á€…á€±á€¬á€„á€·á€ºá€á€±á€¬á€„á€ºá€™á€®á€¸á€¡á€­á€™á€º</h1>
            <p>á€á€±á€¬á€ºá€œá€¾á€”á€ºá€›á€±á€¸ á€¡á€œá€¾á€°á€›á€¾á€„á€ºá€™á€¾á€á€ºá€á€™á€ºá€¸</p>
        </div>

        <div class="card">
            <h3>á€¡á€€á€±á€¬á€„á€·á€ºá€á€„á€ºá€›á€”á€º</h3>
            <input id="loginEmail" placeholder="á€¡á€®á€¸á€™á€±á€¸á€œá€º" type="email">
            <input id="loginPassword" placeholder="á€…á€€á€¬á€¸á€á€¾á€€á€º" type="password">
            <button class="btn-primary" onclick="login()">á€á€„á€ºá€™á€Šá€º</button>
            <button class="btn-secondary" onclick="showRegisterForm()">á€¡á€€á€±á€¬á€„á€·á€ºá€¡á€á€…á€ºá€–á€½á€„á€·á€ºá€›á€”á€º</button>
        </div>

        <div id="registerForm" class="card hide">
            <h3>á€¡á€€á€±á€¬á€„á€·á€ºá€¡á€á€…á€ºá€–á€½á€„á€·á€ºá€›á€”á€º</h3>
            <input id="regName" placeholder="á€¡á€™á€Šá€ºá€¡á€•á€¼á€Šá€·á€ºá€¡á€…á€¯á€¶">
            <input id="regEmail" type="email" placeholder="á€¡á€®á€¸á€™á€±á€¸á€œá€º">
            <input id="regPhone" type="tel" placeholder="á€–á€¯á€”á€ºá€¸á€”á€¶á€•á€«á€á€º">
            <input id="regPassword" type="password" placeholder="á€…á€€á€¬á€¸á€á€¾á€€á€º">
            <button class="btn-primary" onclick="registerUser()">á€–á€½á€„á€·á€ºá€™á€Šá€º</button>
            <button class="btn-secondary" onclick="showLoginForm()">á€”á€±á€¬á€€á€ºá€á€­á€¯á€·</button>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hide">
        <div class="app-header">
            <h1 id="welcomeText">á€™á€„á€ºá€¹á€‚á€œá€¬á€•á€«</h1>
            <p id="roleText"></p>
        </div>

        <div id="contentArea"></div>
    </div>

</div>

<!-- Bottom Navigation -->
<div id="bottomNav" class="bottom-nav hide">
    <button class="nav-btn active" onclick="showTab('home')">ğŸ  á€•á€„á€ºá€™</button>
    <button class="nav-btn" onclick="showTab('donate')">â• á€¡á€œá€¾á€°á€‘á€Šá€·á€º</button>
    <button class="nav-btn" onclick="showTab('support')">ğŸšš á€‘á€±á€¬á€€á€ºá€•á€­á€¯á€·</button>
    <button class="nav-btn" onclick="showTab('list')">ğŸ“‹ á€…á€¬á€›á€„á€ºá€¸</button>
    <button class="nav-btn" onclick="logout()">ğŸšª á€‘á€½á€€á€ºá€™á€Šá€º</button>
</div>

<!-- Notification -->
<div id="notificationContainer"></div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CONFIG
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const APP_NAME = "á€–á€­á€¯á€¸á€…á€±á€¬á€„á€·á€ºá€á€±á€¬á€„á€ºá€™á€®á€¸á€¡á€­á€™á€º";
const APP_VERSION = "1.5.0-fix";

const firebaseConfig = {
    apiKey: "AIzaSyBojMFTkLXmaFGqwq9tLKpXp-wXKqkN_no",
    authDomain: "lamp-88a25.firebaseapp.com",
    databaseURL: "https://lamp-88a25-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "lamp-88a25",
    storageBucket: "lamp-88a25.appspot.com"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

let currentUser = null;
let userRole = '';
let userData = {};
let currentTab = 'home';

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STATE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let offlineDonations = JSON.parse(localStorage.getItem('offlineDonations') || '[]');
let offlineSupports  = JSON.parse(localStorage.getItem('offlineSupports')  || '[]');

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// INIT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('DOMContentLoaded', () => {
    loadOfflineData();
    checkAuthState();
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// AUTH
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function checkAuthState() {
    auth.onAuthStateChanged(user => {
        if (user) {
            currentUser = user;
            userRole = 'admin';
            showMainApp();
        } else {
            const saved = localStorage.getItem('userData');
            if (saved) {
                try {
                    userData = JSON.parse(saved);
                    autoLogin(userData.email, userData.password || '');
                } catch(e) {}
            }
            showLoginPage();
        }
    });
}

async function autoLogin(email, password) {
    try {
        const snapshot = await db.ref('members').orderByChild('email').equalTo(email).once('value');
        let member = null;
        snapshot.forEach(child => {
            const data = child.val();
            if (data.password === password && data.status === 'approved') {
                member = { ...data, id: child.key };
            }
        });
        if (member) {
            userData = member;
            userRole = 'member';
            showMainApp();
        }
    } catch(e) {
        console.error("Auto login failed", e);
    }
}

async function login() {
    const email = document.getElementById('loginEmail').value.trim();
    const pw = document.getElementById('loginPassword').value;

    if (!email || !pw) return showNotification("á€¡á€®á€¸á€™á€±á€¸á€œá€ºá€”á€¾á€„á€·á€º á€…á€€á€¬á€¸á€á€¾á€€á€º á€–á€¼á€Šá€·á€ºá€•á€«", "warning");

    try {
        // Admin á€¡á€›á€„á€ºá€…á€™á€ºá€¸
        try {
            await auth.signInWithEmailAndPassword(email, pw);
            userRole = 'admin';
            showMainApp();
            return;
        } catch(e) {}

        // Member á€…á€™á€ºá€¸
        const snapshot = await db.ref('members').orderByChild('email').equalTo(email).once('value');
        let found = false;
        snapshot.forEach(child => {
            const data = child.val();
            if (data.password === pw && data.status === 'approved') {
                userData = { ...data, id: child.key };
                userRole = 'member';
                localStorage.setItem('userData', JSON.stringify(userData));
                found = true;
            }
        });

        if (found) {
            showMainApp();
        } else {
            showNotification("á€¡á€€á€±á€¬á€„á€·á€ºá€™á€™á€¾á€”á€ºá€•á€«", "error");
        }
    } catch(e) {
        showNotification("á€á€„á€ºá€›á€±á€¬á€€á€ºá€™á€¾á€¯ á€™á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€•á€«", "error");
    }
}

async function registerUser() {
    const name    = document.getElementById('regName').value.trim();
    const email   = document.getElementById('regEmail').value.trim();
    const phone   = document.getElementById('regPhone').value.trim();
    const pw      = document.getElementById('regPassword').value;

    if (!name || !email || !pw) {
        return showNotification("á€œá€­á€¯á€¡á€•á€ºá€á€±á€¬ á€¡á€á€»á€€á€ºá€¡á€œá€€á€ºá€™á€»á€¬á€¸ á€–á€¼á€Šá€·á€ºá€•á€«", "warning");
    }

    try {
        const exists = await db.ref('members').orderByChild('email').equalTo(email).once('value');
        if (exists.exists()) {
            return showNotification("á€¤á€¡á€®á€¸á€™á€±á€¸á€œá€ºá€–á€¼á€„á€·á€º á€¡á€€á€±á€¬á€„á€·á€ºá€›á€¾á€­á€•á€¼á€®á€¸á€•á€«á€•á€¼á€®", "warning");
        }

        const memberData = {
            name, email, phone,
            password: pw,
            status: 'pending',
            role: 'member',
            registeredAt: Date.now()
        };

        await db.ref('members').push(memberData);
        showNotification("á€¡á€€á€±á€¬á€„á€·á€ºá€–á€½á€„á€·á€ºá€•á€¼á€®á€¸á€•á€«á€•á€¼á€®á‹ Admin á€¡á€á€Šá€ºá€•á€¼á€¯á€›á€”á€º á€…á€±á€¬á€„á€·á€ºá€•á€«", "success");
        showLoginForm();
    } catch(e) {
        showNotification("á€¡á€€á€±á€¬á€„á€·á€ºá€–á€½á€„á€·á€ºá€™á€¾á€¯ á€™á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€•á€«", "error");
        console.error(e);
    }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// UI Navigation
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showLoginPage() {
    document.getElementById('loginPage').classList.remove('hide');
    document.getElementById('mainApp').classList.add('hide');
    document.getElementById('bottomNav').classList.add('hide');
}

function showMainApp() {
    document.getElementById('loginPage').classList.add('hide');
    document.getElementById('mainApp').classList.remove('hide');
    document.getElementById('bottomNav').classList.remove('hide');

    document.getElementById('welcomeText').textContent = 
        userRole === 'admin' ? `á€™á€„á€ºá€¹á€‚á€œá€¬á€•á€« Admin` : `á€™á€„á€ºá€¹á€‚á€œá€¬á€•á€« ${userData.name || ''}`;
    document.getElementById('roleText').textContent = 
        userRole === 'admin' ? 'ğŸ‘‘ Admin Panel' : 'ğŸ‘¥ Member';

    showTab('home');
}

function showTab(tab) {
    currentTab = tab;
    document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`.nav-btn[onclick="showTab('${tab}')"]`)?.classList.add('active');

    const area = document.getElementById('contentArea');
    let html = '';

    switch(tab) {
        case 'home':
            html = `
                <div class="card">
                    <h3>ğŸ  á€•á€„á€ºá€™á€…á€¬á€™á€»á€€á€ºá€”á€¾á€¬</h3>
                    <p>á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸ á€¡á€œá€¾á€°á€•á€™á€¬á€ â”€â”€ á€á€½á€€á€ºá€”á€±á€•á€«á€á€Šá€º...</p>
                    <p>á€”á€±á€¬á€€á€ºá€†á€¯á€¶á€¸ á€¡á€œá€¾á€° â”€â”€ á€–á€á€ºá€”á€±á€•á€«á€á€Šá€º...</p>
                </div>
            `;
            break;

        case 'donate':
            if (userRole !== 'admin') {
                html = '<div class="card"><h3>Admin á€á€¬ á€¡á€œá€¾á€°á€‘á€Šá€·á€ºá€”á€­á€¯á€„á€ºá€•á€«á€á€Šá€º</h3></div>';
                break;
            }
            html = `
                <div class="card">
                    <h3>â• á€¡á€œá€¾á€°á€¡á€á€…á€ºá€‘á€Šá€·á€ºá€›á€”á€º</h3>
                    <input id="donorName" placeholder="á€¡á€œá€¾á€°á€›á€¾á€„á€º á€¡á€™á€Šá€º" required>
                    <input id="donorPlace" placeholder="á€”á€±á€›á€•á€º / á€™á€¼á€­á€¯á€·">
                    <input id="donorAmount" type="number" placeholder="á€•á€™á€¬á€ (á€˜á€á€º)" required>
                    <textarea id="donorNote" placeholder="á€™á€¾á€á€ºá€á€»á€€á€º" rows="3"></textarea>
                    <div class="d-flex justify-between">
                        <button class="btn-secondary" onclick="showTab('home')">á€”á€±á€¬á€€á€ºá€á€­á€¯á€·</button>
                        <button class="btn-primary" onclick="saveDonation()">á€á€­á€™á€ºá€¸á€™á€Šá€º</button>
                    </div>
                    <div id="donationStatus" class="mt-3"></div>
                </div>
            `;
            break;

        case 'support':
            if (userRole !== 'admin') {
                html = '<div class="card"><h3>Admin á€á€¬ á€‘á€±á€¬á€€á€ºá€•á€­á€¯á€·á€‘á€Šá€·á€ºá€”á€­á€¯á€„á€ºá€•á€«á€á€Šá€º</h3></div>';
                break;
            }
            html = `
                <div class="card">
                    <h3>ğŸšš á€‘á€±á€¬á€€á€ºá€•á€­á€¯á€·á€¡á€á€…á€ºá€‘á€Šá€·á€ºá€›á€”á€º</h3>
                    <input id="supportOrg" placeholder="á€¡á€–á€½á€²á€·á€¡á€…á€Šá€ºá€¸ / á€¡á€–á€½á€²á€·á€¡á€™á€Šá€º">
                    <input id="supportAmount" type="number" placeholder="á€•á€™á€¬á€ (á€˜á€á€º)">
                    <input id="supportLocation" placeholder="á€á€Šá€ºá€”á€±á€›á€¬">
                    <textarea id="supportActivity" placeholder="á€œá€¾á€¯á€•á€ºá€›á€¾á€¬á€¸á€™á€¾á€¯ á€¡á€á€±á€¸á€…á€­á€á€º" rows="3"></textarea>
                    <div class="d-flex justify-between">
                        <button class="btn-secondary" onclick="showTab('home')">á€”á€±á€¬á€€á€ºá€á€­á€¯á€·</button>
                        <button class="btn-primary" onclick="saveSupport()">á€á€­á€™á€ºá€¸á€™á€Šá€º</button>
                    </div>
                    <div id="supportStatus" class="mt-3"></div>
                </div>
            `;
            break;

        case 'list':
            html = `
                <div class="card">
                    <h3>ğŸ“‹ á€…á€¬á€›á€„á€ºá€¸á€¡á€¬á€¸á€œá€¯á€¶á€¸</h3>
                    <p>á€œá€¬á€™á€Šá€·á€ºá€—á€¬á€¸á€›á€¾á€„á€ºá€¸á€á€½á€„á€º á€¡á€á€±á€¸á€…á€­á€á€ºá€…á€¬á€›á€„á€ºá€¸ á€•á€¼á€•á€±á€¸á€•á€«á€™á€Šá€º</p>
                </div>
            `;
            break;

        default:
            html = '<div class="card"><h3>á€™á€›á€¾á€­á€á€±á€¸á€á€±á€¬ á€…á€¬á€™á€»á€€á€ºá€”á€¾á€¬</h3></div>';
    }

    area.innerHTML = html;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SAVE FUNCTIONS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function saveDonation() {
    const name   = document.getElementById('donorName')?.value.trim();
    const place  = document.getElementById('donorPlace')?.value.trim();
    const amount = parseFloat(document.getElementById('donorAmount')?.value) || 0;
    const note   = document.getElementById('donorNote')?.value.trim();

    if (!name || amount <= 0) {
        return showNotification("á€¡á€™á€Šá€ºá€”á€¾á€„á€·á€º á€•á€™á€¬á€ á€–á€¼á€Šá€·á€ºá€•á€«", "warning");
    }

    const donation = {
        name, place, amount, note,
        week: getCurrentWeek(),
        timestamp: Date.now(),
        synced: false,
        recordedBy: userRole === 'admin' ? 'admin' : (userData.name || 'member')
    };

    const status = document.getElementById('donationStatus');
    status.innerHTML = '<span class="text-warning">á€á€­á€™á€ºá€¸á€”á€±á€•á€«á€á€Šá€º...</span>';

    try {
        if (navigator.onLine) {
            await db.ref('donations').push(donation);
            status.innerHTML = '<span class="text-success">á€á€­á€™á€ºá€¸á€•á€¼á€®á€¸á€•á€«á€•á€¼á€® âœ“</span>';
        } else {
            donation.id = 'off_' + Date.now();
            offlineDonations.push(donation);
            localStorage.setItem('offlineDonations', JSON.stringify(offlineDonations));
            status.innerHTML = '<span class="text-warning">Offline á€á€­á€™á€ºá€¸á€•á€¼á€®á€¸áŠ á€¡á€„á€ºá€á€¬á€”á€€á€ºá€›á€œá€»á€¾á€„á€º sync á€œá€¯á€•á€ºá€•á€«á€™á€Šá€º</span>';
        }

        clearDonationForm();
    } catch(e) {
        status.innerHTML = `<span class="text-danger">á€á€­á€™á€ºá€¸á€™á€›á€•á€« â€” ${e.message}</span>`;
        console.error(e);
    }
}

function clearDonationForm() {
    ['donorName','donorPlace','donorAmount','donorNote'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
    });
}

async function saveSupport() {
    const org      = document.getElementById('supportOrg')?.value.trim();
    const amount   = parseFloat(document.getElementById('supportAmount')?.value) || 0;
    const location = document.getElementById('supportLocation')?.value.trim();
    const activity = document.getElementById('supportActivity')?.value.trim();

    if (!org || amount <= 0) {
        return showNotification("á€¡á€–á€½á€²á€·á€¡á€™á€Šá€ºá€”á€¾á€„á€·á€º á€•á€™á€¬á€ á€–á€¼á€Šá€·á€ºá€•á€«", "warning");
    }

    const support = {
        organization: org,
        amount, location, activity,
        week: getCurrentWeek(),
        timestamp: Date.now(),
        synced: false,
        recordedBy: userRole === 'admin' ? 'admin' : (userData.name || 'member')
    };

    const status = document.getElementById('supportStatus');
    status.innerHTML = '<span class="text-warning">á€á€­á€™á€ºá€¸á€”á€±á€•á€«á€á€Šá€º...</span>';

    try {
        if (navigator.onLine) {
            await db.ref('supports').push(support);
            status.innerHTML = '<span class="text-success">á€á€­á€™á€ºá€¸á€•á€¼á€®á€¸á€•á€«á€•á€¼á€® âœ“</span>';
        } else {
            support.id = 'sup_off_' + Date.now();
            offlineSupports.push(support);
            localStorage.setItem('offlineSupports', JSON.stringify(offlineSupports));
            status.innerHTML = '<span class="text-warning">Offline á€á€­á€™á€ºá€¸á€•á€¼á€®á€¸áŠ sync á€…á€±á€¬á€„á€·á€ºá€”á€±á€•á€«á€á€Šá€º</span>';
        }

        clearSupportForm();
    } catch(e) {
        status.innerHTML = `<span class="text-danger">á€á€­á€™á€ºá€¸á€™á€›á€•á€« â€” ${e.message}</span>`;
        console.error(e);
    }
}

function clearSupportForm() {
    ['supportOrg','supportAmount','supportLocation','supportActivity'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
    });
}

function getCurrentWeek() {
    const d = new Date();
    const start = new Date(d.getFullYear(), 0, 1);
    const days = Math.floor((d - start) / 86400000);
    return Math.ceil((days + start.getDay() + 1) / 7);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// UTILITY
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showNotification(msg, type = 'info') {
    const div = document.createElement('div');
    div.className = `notification text-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'warning'}`;
    div.textContent = msg;
    document.getElementById('notificationContainer').appendChild(div);
    setTimeout(() => div.remove(), 4000);
}

function showLoginForm() {
    document.getElementById('registerForm').classList.add('hide');
    document.getElementById('loginPage').querySelector('.card:not(.hide)').classList.remove('hide');
}

function showRegisterForm() {
    document.getElementById('registerForm').classList.remove('hide');
    document.getElementById('loginPage').querySelectorAll('.card:not(#registerForm)').forEach(el => el.classList.add('hide'));
}

function logout() {
    if (!confirm("á€‘á€½á€€á€ºá€™á€Šá€ºá€œá€¬á€¸?")) return;
    auth.signOut();
    localStorage.removeItem('userData');
    showLoginPage();
}

function loadOfflineData() {
    offlineDonations = JSON.parse(localStorage.getItem('offlineDonations') || '[]');
    offlineSupports  = JSON.parse(localStorage.getItem('offlineSupports')  || '[]');
}
</script>
</body>
</html>